name: magento-lando
recipe: lemp
config:
  webroot: docroot/pub
  php: '7.4'
  database: mariadb:10.4
  xdebug: 'false'
  composer_version: '2.0.7'
  config:
    php: config/php.ini
    vhosts: config/nginx.conf

proxy:
  appserver_nginx:
    - magento2.lndo.site
  mailhog:
    - mailhog.lndo.site
  phpmyadmin:
    - pma.lndo.site

services:
  appserver:
    type: php:7.4
    build_as_root:
      - apt update -y -q && apt install -y libxslt-dev cron && docker-php-ext-install xsl sockets sodium
    run_as_root:
      - service cron start
    xdebug: true
    overrides:
      environment:
        # support debugging Drush with XDEBUG.
        PHP_IDE_CONFIG: "serverName=appserver"
        LANDO_HOST_IP: "host.docker.internal"
        XDEBUG_CONFIG: "remote_enable=1 remote_host=host.docker.internal"

  database:
    # You can connect externally via "external_connection" info from `lando info`.
    portforward: true
    creds:
      # These credentials are used only for this specific instance.
      # You can use the same credentials for each Lando site.
      user: magento
      password: magento
      database: magento

  phpmyadmin:
    type: phpmyadmin
    hosts:
      - database

  elasticsearch:
    type: elasticsearch:7.10.2
    portforward: 9200
    mem: 1025m
    build_as_root:
      - echo "vm.max_map_count=262144" >> /etc/sysctl.d/elasticsearchSpecifications.conf && sysctl --system
    overrides:
      environment:
        - discovery.type=single-node
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
  
  redis:
    type: redis
    persist: false
    portforward: 6379

  mailhog:
    type: mailhog
    portforward: 1025
    hogfrom:
      - appserver

tooling:
  xdebug-on:
    service: appserver
    description: Enable xdebug
    cmd: docker-php-ext-enable xdebug
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    user: root
